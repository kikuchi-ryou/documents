# セッション４：コスト最適化アーキテクチャを設計する

## コストを最適化したストレージの設計方法を決定する

従量課金制が基本
一部のサービスでは予約により値引きすることができ、時間単位で大幅な割引があるリザーブドキャパシティを利用可能
ストレージとデータ転送の料金設定は階層化
使用量の増加に応じて GBあたりの料金が低くなる

リージョンから外に出る送信に関して料金
リージョンの外からの受信データや同一リージョン内AWSサービス間の送受信データについては料金が発生しない
EC2,S3,RDS,SQS,SNS,VPCからの送信データは集約され、送信データ転送のレートで課金される
この料金はAWS DATA transfer outという項目で記載される。

## Amazon EC2の使用コストの見積もりにおける検討事項

- サーバーの実働時間
    - Amazon Linux、Ubuntuは秒課金、それ以外の OS は1時間単位の課金
- マシン構成
    - 選択するインスタンスタイプによって料金が変動
- マシン購入タイプ
    - オンデマンドインスタンス、リザーブドインスタンス、スポットインスタンスにより料金が変動
- インスタンス数
- ロードバランシング
    - ELBを利用するELBの料金がかかる
- 詳細モニタリング
    - デフォルトでは5分間隔でクラウドウォッチにメトリクスが収集
    - 詳細モニタリングを利用すると1分単位でメトリックスが収集されるが、追加料金が発生する
- Auto Scaling
    - Auto Scalingそのものに料金は発生しない
    - 自動的に起動したEC2インスタンスに対して課金される
- Elastic IPアドレス
    - Elastic IPは**利用していないと発生する**
    - アタッチしていても、EC2を停止している場合に料金が発生
- OSとソフトウェアパッケージ
    - 利用する料金によって決まる

EC2インスタンスのサイズタイプファミリーを検討する時ワークロードと完了するまでにかかる時間を考慮することが重要
小さなインスタンスを長時間実行するよりも大きいインスタンスでバッチジョブを素早く完了させる方が安価になる場合がある

## コンピューティングの違い

デフォルトは共有テナンシー
コンプライアンスやライセンス的に共有テナンシーが適用できない場合がある
その場合は、専用テナンシーを利用
専用テナンシーには追加料金

料金オプションは、オンデマンド、リザーブド、スポットから選択できる
選択するインスタンスタイプによってはインスタンスストレージが利用可能
インスタンスストレージはインスタンス利用料金に含まれており無料で利用可能

## EC2のコスト削減

- 最適なインスタンスファミリーを選択すること
- 使用していないインスタンスは停止もしくは終了しておくこと
- 最適な料金オプションを選択すること

- オンデマンドインスタンスの最大の特徴は使ったぶんだけ課金となり事前契約などは不要
    - 非常に柔軟性の高い利用が可能
    - インスタンスを削除したら料金は発生しない

- 起動し続けておく必要のあるインスタンスをより安く利用できる料金オプションとしてリザーブドインスタンス
    - システムには24時間365日ずっと起動している必要になるサーバーに役立つ
    - スタンダードとコンバーティブルの違いは事前の購入条件の後から変更可能な柔軟性の違い
    - スタンダードではインスタンスファミリーや OS などは後から条件の変更ができない
    - コンバーティブルでは変更が可能
    - スタンダードよりもコンバーティブルの方が割引率が低い
    - スケジュールされたリザーブドインスタンスは特定の時間帯に対するキャパシティをあらかじめ予約しておく方式
    - 例えば毎週金曜日の夜中に実施するバッチ処理があるなど予測可能で定期的なスケジュールに対するキャパシティの予約に適している
- スポットインスタンスは AWS が管理しているハードウェアの中で利用していないコンピューティングリソースを低価格で利用できるようにした料金オプション
    - オンデマンド料金と比べて大幅な割引価格で利用可能
    - 空いているコンピューティングリソースは需要と供給により増減
    - 空きリソースがなくなるとお客様が起動したスポットインスタンスが強制的に中断させられる可能性がある
    - 中断される場合は2分前に通知
    - スポットインスタンスの中断時には休止／停止／終了のいずれかの動作を指定
    - 休止を選択すると OS に吸収を実行するように合図が送られメモリー上のデータはEBSルートボリュームに保存






